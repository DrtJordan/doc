define(function(require, exports, module) {

	var CORAL_LOGIN = require("coral.login");
	var CORAL_CONFIG = require('coral.config');


	window._ptLoginSuccessHandls = [];
	// 登录成功的回调
	window.loginAll = function(data){
		if(data.result != 0){
			console.log("获取已登陆用户信息错误（qfwd）代码：" + data.result);
			return;
		}
		for(i = 0, l = window._ptLoginSuccessHandls.length; i < l; i++){
			window._ptLoginSuccessHandls[i](data);
		}
	};


	// 读取COOKIES
	QQ = {};
	QQ.Cookie={
		set:function(name,value,expires,path,domain){
			if(typeof expires=="undefined"){
				expires=new Date(new Date().getTime()+3600*1000);
			}
			document.cookie=name+"="+escape(value)+((expires)?"; expires="+expires.toGMTString():"")+((path)?"; path="+path:"; path=/")+((domain)?";domain="+domain:"");
		},
		get:function(name){
			var arr=document.cookie.match(new RegExp("(^| )"+name+"=([^;]*)(;|$)"));
			if(arr!=null){
				return unescape(arr[2]);
			}
			return null;
		},
		clear:function(name,path,domain){
			if(this.get(name)){
				document.cookie=name+"="+((path)?"; path="+path:"; path=/")+((domain)?"; domain="+domain:"")+";expires=Fri, 02-Jan-1970 00:00:00 GMT";
			}
		}
	};

	// 检测QQ是否登录 如果登录的话则 执行回调
	QQ.loginCheck = function(){
		if(QQ.Cookie.get("skey")){
			uin = Number(QQ.Cookie.get("uin").substring(1));
			skey = QQ.Cookie.get("skey");
			try{
				var loginScript = document.createElement ("script");
				loginScript.charset="utf-8";
				loginScript.src = "http://qfwd.qq.com/?uin=" + uin + "&skey=" + skey + "&func=loginAll&refresh=0&ran="+Math.random();
				document.getElementsByTagName('head')[0].appendChild(loginScript);
				QQ.localData.set("loginTime", (new Date()).getTime());
			}catch(e){}
		}
	};


	// 注册 PTlogin登录成功时间
	QQ.addLoginedEvent = function(func){
		window._ptLoginSuccessHandls.push(func);
	};

	// 导出接口
	var API = {};

	// 组建初始化
	API.init = function(config){
		// 设置参数
		if(config instanceof Object){
			for(key in config){
				if(!config.hasOwnProperty(key)){
					continue;
				}
				CORAL_CONFIG.options[key] = config[key];
			}
		}

		// 检查登录状态 如果已经等了的话则 初始化评论组建
		var uin = QQ.Cookie.get("uin");
		var skey = QQ.Cookie.get("skey");

		// 绑定登录后获取用户信息事件
		QQ.addLoginedEvent(function(data){
			var uin = QQ.Cookie.get("uin");
			CORAL_LOGIN.onLogined(uin, data.nick, data.Face);
		});

		if(uin && skey){
			QQ.loginCheck();
		}

		// 绑定PTlogin 的登出按钮
		CORAL_CONFIG.options.publicLogout = function(){
			pt.logout(function(status){
				if(status == 0){
					alert("登出QQ失败");
					return;
				}
				CORAL_LOGIN.loginOut();
			});
		};

		// 绑定登录操作事件
		CORAL_CONFIG.options.loginEvent = function(){
			pt.showPtui();
		};

		// 绑定 PTlogin 登录框成功事件
		window.addEventListener("message", function(e){
			if(e.data.pt_login == "ok"){
				QQ.loginCheck();
				pt.hidePtui();
			}
		});
		var CORAL = require("coral_v3.6.29");
		// 初始化评论框
		CORAL._create();
	};

	module.exports = API;
});