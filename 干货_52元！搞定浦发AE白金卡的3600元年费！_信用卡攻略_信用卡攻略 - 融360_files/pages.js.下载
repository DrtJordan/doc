// 添加广点通cookie mapping代码
var imgs = new Image();
imgs.src = '//cm.e.qq.com/cm.fcg?gdt_dspid=1007253&gdt_dsp_timestamp='+parseInt(new Date().getTime()/1000);
//移动端跳转
var url = window.location.href;
var data = url.split("/");
var id = data[data.length-1];
try {
  if ((navigator.userAgent.match(/(iPhone|iPod|Android|ios|iPad)/i))){
    window.location.href="//m.rong360.com/article/view/" + id;
  }
}
catch(err){
}
var pid;
$(function(){
  var typenamehit = 0;
  $('.crumbs a').each(function(){
    var typename = $(this).html();
    $('.header-menu li').each(function(){
      if($(this).attr('data-typename')==typename){
        $(this).find('a').css('background-color','#375aab').css('color','#fff').addClass("current");
        $(this).next().css('background-image', 'none');
        typenamehit = 1;
        return;
      }
    });
    if(typenamehit==1){
      return;
    }
  });

  if($("#subTypes li").length<=0){
    $("#subTypes").hide();
  }
  if($(".act-relevance li").length<=0){
    $(".act-relevance").hide();
  }


  if($(".guess-youlike .links a").length<=0){
    $(".guess-youlike").hide();
  }


  $(".header-menu li").hover(
    function(){
      $(this).find('a:not(.current)').removeAttr("style");
      $(this).next().find('a:not(.current)').css('background-color', '#fff');
    },
    function(){
      $(this).next().find('a:not(.current)').removeAttr("style");
    }
  );
  $("#sel_search_type").click(function(){
    $(".search-list").toggle();
  });
  $(".search-list a").click(function(){
    var tname = $(this).html();
    var tvalue = $(this).attr("data-value");
    $("#sel_search_type .sbl-text").html(tname);
    $("#search_type").val(tvalue);
    $(".search-list").hide();
    if(tvalue=='12' && $("#keyword").val()==''){
      $("#keyword").attr("placeholder", "城市名称");
    }
    else{
      $("#keyword").attr("placeholder", "");
    }
  });
  $(".search-select").hover(
    function(){
    },
    function(){
      $(".search-list").hide();
    }
  );

  $("#sel_search_type_b").click(function(){
    $(".search-list-b").toggle();
  });
  $(".search-list-b a").click(function(){
    var tname = $(this).html();
    var tvalue = $(this).attr("data-value");
    $("#sel_search_type_b .sbl-text-b").html(tname);
    $("#search_type_b").val(tvalue);
    $(".search-list-b").hide();
    if(tvalue=='12' && $("#keyword-l").val()==''){
      $("#keyword-l").attr("placeholder", "城市名称");
    }
    else{
      $("#keyword-l").attr("placeholder", "");
    }
  });
  $(".search-select-b").hover(
    function(){
    },
    function(){
      $(".search-list-b").hide();
    }
  );

  $("#today_hot .tab-bar a").click(function(){
    var index = $(this).closest("li").index();
    $(this).closest("li").addClass("active").siblings().removeClass("active");
    $("#today_hot .atc-list:eq("+index+")").show().siblings().hide();
  });

  $(".atc-left .tab-bar a").click(function(){
    var index = $(this).closest("li").index();
    $(this).closest("li").addClass("active").siblings().removeClass("active");
    $(".atc-left .act-relevance:eq("+index+")").show().siblings().hide();    
  });
  pid = getCookie('RONGID') + new Date().getTime();
  var img = document.createElement('img');
  img.src = get_ra();
  read_log();
  focusClickLog();
});


function getCookie(c_name)
{
  if (document.cookie.length>0)
  {
    c_start=document.cookie.indexOf(c_name + "=")
      if (c_start!=-1)
    { 
      c_start=c_start + c_name.length+1 
      c_end=document.cookie.indexOf(";",c_start)
      if (c_end==-1) c_end=document.cookie.length
      return unescape(document.cookie.substring(c_start,c_end))
    } 
  }
  return ""
}

function setCookie(c_name,value,expiredays)
{
  var exdate=new Date()
  exdate.setDate(exdate.getDate()+expiredays)
  document.cookie=c_name+ "=" +escape(value)+
  ((expiredays==null) ? "" : ";expires="+exdate.toGMTString())
}

function getQueryValue(key) {
  var url = document.location.search;
  var reg = new RegExp("(^|&|\\?|#)" + key + "=([^&#]*)(&|\x24|#)", "");
  var match = url.match(reg);
  if (match) {
    return match[2];
  }
  return null;
}

function get_ra(arg_page_name){
  var rongid = encodeURIComponent(getCookie('RONGID'));
  var host = encodeURIComponent(window.location.hostname);
  var referrer = encodeURIComponent(document.referrer);
  var url = encodeURIComponent(window.location.href);
  var city = getCookie('cityDomain');
  var utmz = getCookie('__utmz'); //using a cookie reading function
  var vals = (function() {
          var pairs = utmz.split('.').slice(4).join('.').split('|');
          var ga = {};
          for (var i = 0; i < pairs.length; i++) {
              var temp = pairs[i].split('=');
                  ga[temp[0]] = temp[1];
          }
          return ga;
      })();
  var abclass = getCookie('abclass');
  var pagename_full = window.page_name || ''
  pagename_full = arg_page_name || pagename_full;
  abclass = abclass.split('_')[1]; //abclass.substr(abclass.indexOf('_')+1, 1);
  return '//g.rong360.com/u.gif?rid=' + rongid +'&city='+ city + '&url=' + url + '&rf=' + referrer + '&host=' + host + '&ga_csr=' + encodeURIComponent(vals.utmcsr) + '&ga_ccn=' + encodeURIComponent(vals.utmccn) + '&ga_cmd=' + encodeURIComponent(vals.utmcmd) + '&ga_ctr=' + encodeURIComponent(vals.utmctr) + '&rtm=' + encodeURIComponent(getCookie('__rtm')) + '&channel=gonglue&abclass='+abclass+'&page_name='+ encodeURIComponent(pagename_full)+'&pid='+encodeURIComponent(pid);
}

/**
 *阅读时间统计 
 */

function read_log() {
	var timeSpan = 15000;
	var maxCall = 10;
	var rid = getCookie('RONGID');
	var page_name = window.page_name || '';
	var url = window.location.href;
	var events_name = 'Article_Read';
	var ent_time = new Date().getTime();
	var up_events_time = ent_time;
	var click_arr = [],
	    focus_arr = [],
	    blur_arr = [],
	    scroll_arr = [];

	$('body').click(function() {
		click_arr.push(new Date().getTime() - ent_time);
	});
	$(window).focus(function() {
		focus_arr.push(new Date().getTime() - ent_time);
	}).blur(function() {
		blur_arr.push(new Date().getTime() - ent_time);
	}).scroll(function() {
		scroll_arr.push(new Date().getTime() - ent_time);
	});
	var callTimes = 0;
	function getEventExt() {
		click_arr_temp = click_arr;
		click_arr = [];
		focus_arr_temp = focus_arr;
		focus_arr = [];
		blur_arr_temp = blur_arr;
		blur_arr = [];
		scroll_arr_temp = scroll_arr;
		scroll_arr = [];
		var result = [];
		result.push(click_arr_temp.join(','));
		result.push(focus_arr_temp.join(','));
		result.push(blur_arr_temp.join(','));
		result.push(scroll_arr_temp.join(','));
		return result.join('|');
	}

	function callResuest() {
		var eventExt = getEventExt();
		if (eventExt.length > 4) {
			var param = {
				rid : rid,
				page_name : page_name,
				ent_time : ent_time,
				url : url,
				pid : pid,
				events_name : events_name,
				events_time : new Date().getTime(),
				events_para : id.split('.')[0],
				up_events_time : up_events_time,
				events_ext : eventExt
			}
			up_events_time = param.events_time;
			var img = document.createElement('img');
			img.src = '//g.rong360.com/r.gif?' + $.json2param(param);
			callTimes++;
		}
		if (callTimes < maxCall) {
			setTimeout(callResuest, timeSpan);
		}
	}

	setTimeout(callResuest, timeSpan);
}

function focusClickLog(){
	$('#go-focus').click(function(){
		var img = document.createElement('img');
		var param = {
			events_name : 'foucs-ad-click',
			url: encodeURIComponent(url)
		};
		img.src = '//g.rong360.com/t.gif?' + $.json2param(param);
	});
}

